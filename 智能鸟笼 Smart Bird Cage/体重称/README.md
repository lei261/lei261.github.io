# 体重秤

体重秤的背景：<br>
注意：这些为个人经验，非权威观点。<br>
鸟的健康观察个人感觉主要分三大板块：<br>
1. 我们人眼看来，鸟有没有明显病态 (如闭眼，精神不好）<br>
  -- 一般鸟在生病的时候会隐藏自己的症状（不让敌人发现），所以有时候我们往往不能第一时间洞察鸟的病态。过去经验里，经常会有似病非病，决定先观察几天的情况。<br>
2. 体重骤降<br>
  -- 正常健康的成鸟，如成年猫/狗，不是经常生病的，导致我们平时这方面的意识松散，往往是感觉鸟有问题了，测一下体重，要么就是发现已经骤降，赶紧用药/送医，或者是好久不测了，这个体重到底正常吗？<br>
3. 💩 颜色以及形态<br>
  -- 个人感觉，除非天天换鸟屎盆，很难有敏锐的洞察力。有些是因为💩混在一起，看不清；也有是因为吃了带色素的水果，导致颜色变化。这个的观察一定是一个时间段的观察，常人很难用肉眼从一次排便就能推断出鸟生病了。~~~难~~~~<br>
     当然我也看到过猫圈里，有人声称天天观察猫便便 软硬程度的。我肯定做不到。。。我认识的主子们也做不到。。。<br>


这个项目的目标是鸟的健康监测，以我目前的能力 以及 用户接受程度来说（天天检查屎是不可能的 😂), 体重秤(2)是一个容易做，效果也不错的方案。

### 体重秤可分为三部分：硬件（形态），电器（传感器 + 信号变送器）+ 软件 （ESPHome / C / C++）


## 形态：
初步判断主分三类：
1. 站杆
2. 平台
3. 吊挂（如 悬挂式鸟窝）
起初是最想做 （3），因为一般鸟睡觉的时候 以及 同一时间段内，测出来的是最准的 也是 最有对比意义的。<br>
但因为鸟笼这时结构已经定形，改装空间不是很够，会导致传感器 以及 引线 外露，容易被鸟啃坏，所以被排除。<br>

因为期望鸟每天都能上去几次，我想调查鸟最喜欢哪个形态的休息地点。我做了一个测试，在一个空鸟笼内（只有铁丝网，木板，木头站杆），我用摄像头记录了鸟活动场景。
结论是鸟最喜欢站杆，他每天会花大量的时间站在站杆上，所以我最终尝试去做（1）。虽然后面事实证明这个想法以及验证方法是有问题的。。。。

在决定做站杆后，因为之前做 水暖站杆 时发现，3D打印的站杆表面较滑（砂纸 + 粗糙纹路 效果也不佳），加硅胶套/吸汗带/牛皮 会导致这是一个需要被维护的产品。
最后决定将免维护为高优先级，决定了用花椒木。

<p float="left">
  <img src="https://user-images.githubusercontent.com/1382734/217904217-c510e0ec-7804-4417-a535-1c0bce98a598.png" width="500" height="400">
  <img src="https://user-images.githubusercontent.com/1382734/217904370-c78c4dd8-1593-4a46-8629-edb7e48e7483.png" width="500" height="400">
</p>

最终是用修边机在树杆中挖槽，将称重传感器 与 传感器支架 夹在中间。<br>
再来一次的话，我可能不会选木头了 😂

### 传感器 + 变送器
称重传感器：<br>
个人其实不是很懂，但选择的时候考虑了以下几点因素：<br>
1. 品牌 以及 做工 <br>
   传感器从￥3 到 ￥300或以上 都有，这些特征的直接被我排除：铸造，非机加工；无完整产品参数；无屏蔽线；卖家表示只卖货，不懂货 等等。。。<br>
2. 量程 <br>
   理论来说，我的鸟重100多g，加上木杆100多g，我最多需要500g的传感器就足够了。量程越低，ADC在同等情况下读出的精度更高，也可以在ADC上省钱 <br>
   但是传感器都有一个安全过载范围，大多在120% - 150%量程左右。考虑到我这个是样品，我在测试以及安装是 有99%的可能不小心多施加了力，最终选了1kg的量程 <br>
3. 精度 <br>
   理论来说，我得通过传感器 非线性 灵敏度 零飘 以及等等ADC参数 算出我的精度够不够。但是C3精度是我愿意承受价格范围内最高精度了，就算达不到要求，我也得接着用。。。所以就没算。。
4. 秤盘尺寸 <br>
   因为树杆大约长20-25cm，在0点的测量值 与 25cm点的测量值 差多少？ 传感器参数表会有尺寸限制，我在家里厨房称上（量程500g，物体~100g）比较了 0点 与 30cm点的差值，几乎没有差（<1g)。
   以及我尝试画了FBD，我确实到现在也不是很理解这部分，但是在我的应用力，它没有对我造成明显影响。
   
变送器：<br>
一开始我就想用HX711试一下，当时正好疫情被锁家里，没快递，硬件没进展，就多阅读了一些ADC的资料。在Arduino圈里，HX711的评论并不是很好，当然这可能跟传感器，杜邦线，面包板都有关，毕竟这是一个高精度测量仪器。
最后我没用HX711的原因是：
1. 疫情后我拿到了一个很普通的HX711模块，与ESP32插在面包板上做了一些测试。初步测试结果很不好看，精度可能在 +/- 10g （百分之一）
2. 国外某评论：“HX711温漂以及蠕变很不理想，我很少看到将LDO直接放在ADC芯片上的，一般电源芯片是要与信号分开的，HX711的精度问题是不是因为他的设计造成的呢？”
   我觉得他说的好像很有道理，就决定找一个不同的芯片。<br>
现在在回过头看来，我可能会再对比对比HX711，但从个人角度来说，最多省几瓶矿泉水的钱。<br>

选ADC时，最重要的问题就是，我要多少精度？<br>
我的鸟平时为140g，当时我错误的认为 -5g 就属于要送医的程度了，实际问了医生大概是 -10g左右需要送医。<br>
如果-5g就要送医了，精度最差我也要达到 +/- 0.5g，这样保证1g的精度。考虑到还会有噪音以及实际低于设计预期的情况，我将设计目标精度设为了0.1g, 也就是+-/ 0.05g 。

关于ADC，我建议大家更多阅读资料，我的只能给小白参考参考，开个思路
好像有2种方法来看此ADC是否能达到你需求，但两者原理是一样的<br>
A：看NSB（Noise-free bits) <br>
B: 直接算Vpeak-peak
像ADS1232这个芯片, $Vref = AVDD ~= 5V$, 传感器激励电压 0.2mV/V。 $FSR = V_excit * AVDD = 10mV$ <br>
要达到+/-0.1g，也就需要 $ADCVpp = 0.1 / 1000 = 0.0001$  --> 万分之一的精度<br>
$FSR * 0.0001 = 1000nV$ <br>
所以如果我们选择一个ADC Vpp-noise <= 1000nV,就能达到目标

在研究了Analog Device 和 TI 的ADC catalog之后，以及比较淘宝价格（因为芯片便宜不代表我能以合适的样品价买到），最终选了ADS1232。
 <img src="https://user-images.githubusercontent.com/1382734/217997275-2cbf35b4-84b0-468f-a1dd-d4332595ade9.png" width="900" height="200"> <br>

### 软件 / 固件：
虽然很多人说ADS1232不是SPI device，但他确实应该是可以用SPI来读取的。TI官方也推荐用SPI来读。
 <img src="https://user-images.githubusercontent.com/1382734/218010421-612e8970-cf23-4875-9b7b-85dd85aa6a0e.png" width="700height="100"> <br>
 
 <a href="https://e2e.ti.com/support/data-converters-group/data-converters/f/data-converters-forum/1061517/ads1232-interfacing-of-microcontroller-with-ads1232"> 参考链接 </a>

 在尝试了一圈后，发现最简单的是用HX711 Gain128来读 😂
 虽然说ADS1232只需要24个pulse就可以读数据，HX711 Gain128有25个pulse。但在ADS1232 datasheet中，官方推荐读25个pulse，防止万一被卡咋上一个cycle里。
  
  <img src="https://user-images.githubusercontent.com/1382734/218011220-12109ed6-3510-4b46-9a77-8107a53d6862.png" width="800" height="1000"> <br>

有了正确的Library后，考虑到鸟会在站杆上跳/活动 导致测量不稳定；加上一些算法，如取多点Avg，比较一组数据中最大最小值 等等
软件逻辑还需根据具体情况调试 以及 测试， 以降低误测

