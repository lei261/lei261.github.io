# 物联网部分主分几大块，ESP32控制器, Home Assistant 本地服务器 和 NodeRed微信控制+推送。及小米设备及网关<br>

前言：
最早给小太阳育雏的时候，为了稳定温度，用小米温湿度传感器+小米智能开关+加热灯 + 一个封闭育雏箱，简单拼了一个“智能温控系统”。其实就是 “如果温度 > x°C，则关闭开关 | 如果温度 < x°C, 则打开开关”。<br>
因为功课做的不足，我万万没想到这套控制系统有很大的延迟。首先，小米温湿度传感器温度上传频率非常低，可能20分钟上传一次温度，不像绿米温度传感器（每变化0.5°C，则上传温度）；其次，网关收到信号后，居然不是本地判断+执行的！也就是说如果你正好断网断流一会，控制逻辑则会等到网络恢复 还是 下次数据上传给服务器 才会执行。在后来的调查中，发现很多养鱼或者其他圈的也被这套系统坑过。<br>

因为我功课没做好，直接导致3星期左右大的小太阳在50°C的环境中 呆了可能有20分钟。当时整个鸟眼镜就闭上了，尽管送医救了回来，几天后的凌晨，小鸟突然暴毙了。<br>
因为这个失误老婆痛哭的场景我永远记在心里，告诫自己要细心严谨。

我也能理解，有时候我跟别人说我这套逻辑中的冗余逻辑，总会被认为是“over-engineered”，或是太费精力费钱或者没必要。<br>
说实话，我这套逻辑还是有漏洞的，但确实我觉得在合适的价格里做到我自认为reliable了，以及有足够冗余了。

之前小佩闹出的饮水机电死猫，猫窝翻了，导致猫窒息；以及其他品牌电动猫砂盆夹死猫现象。<br>
个人想法：小佩在1代猫砂盆里加了很多传感器，就是为了避免事故发生。但是小佩在“2代”猫砂盆里做了一些优化，但也做了一些减法，估计是降本。<br>
作为工程师，有些事故确实比较难预料，也很难完全避免，我们只能尽可能在安全与成本中找到一个平衡点。<br>

Anyway.



# ESP32:<br>

<img src="https://user-images.githubusercontent.com/1382734/217273326-d0e99e39-cd2b-41f0-9a1f-8914bd947908.png" width="400" height="300">

电路图：
注意！！！ 我并不是EE出身，只不过有幸跟别人学了一点，大多都是自己谷歌出来的。没有任何保证, Use at your own risk.

<a href="https://github.com/lei261/lei261.github.io/blob/main/%E6%99%BA%E8%83%BD%E9%B8%9F%E7%AC%BC%20Smart%20Bird%20Cage/IoT%20%E5%8A%9F%E8%83%BD/Bird%20Cage%20Control%20v4%20Schematic.pdf"> 查看电路图，Schematics Share </a>

ESP的核心功能有：
1. 温度测量（共9个温度计) <br>
  --在温度过低，或者过高时候，强制启动保暖/通风程序
2. 通风扇开关与控制<br>
  --PWM控制风扇速度，同时监测RPM数据，确保暖风模式的电器安全
3. PID控制器、PTC电源、以及485通讯<br>
  --暖风 与 加热平台的开关<br>
  --485通讯，确保温度在预期范围内，若有不正常，则断电。确保PTC加热设备的电器安全<br>
  --自检程序，确保PTC加热设备的电器安全<br>
4. 体重测量<br>
  --集成ADS1232芯片，获取体重秤数据


# Home Assitant:


<img src="https://user-images.githubusercontent.com/1382734/217272975-b6ff87fa-e16d-4482-95ba-0aed1bb4f53a.png" width="900" height="600">

HA的核心功能为：
1. APP的 UI以及前端控制
2. 集成米家设备（如电动窗帘），增加温度测量、控制的冗余。
4. 设计时担心若ESP32卡死，并且不能自我恢复, 可以进行power cycle。（目前看来概率挺小，并且ESP32本身集成WacthDog）

理想情况下，这个APP会是低频工具，但是功能得齐，看着得舒服。



# 微信推送+控制：<br>

<img src="https://user-images.githubusercontent.com/1382734/217273670-72937f08-5314-442f-9899-8162d8fda784.png" width="800" height="700">

这部分做在了NodeRed里，因为NodeRed社区有现成的企业微信推送和收发模块。<br>
其实这个也可以做在HA里，自己调用收发的API就行。目前想法是这个HA instance主要给鸟笼使用，家用的智能控制放在了NodeRed里。

核心功能：
1. 问题警报<br>
  -- 体重过低报警 <br>
  -- 温度过低/高 报警 <br>
  -- 系统问题报警（如ESP长时间下线）<br>
2. 提醒<br>
  -- 如 每X小时 换屎盆<br>
3. 简易核心功能控制

理想情况下，微信推送会比APP使用更高频，但使用起来得方便。




