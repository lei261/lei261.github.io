物联网部分主分三块，ESP32, Home Assistant 本地服务器 和 NodeRed微信控制+推送。    及小米设备及小米网关

前言：
最早给小太阳育雏的时候，为了稳定温度，用小米温湿度传感器+小米智能开关+加热灯 + 一个封闭育雏箱，简单拼了一个“智能温控系统”。其实就是 “如果温度 > x°C，则关闭开关 | 如果温度 < x°C, 则打开开关”。
因为功课做的不足，我万万没想到这套控制系统有很大的延迟。首先，小米温湿度传感器温度上传频率非常低，可能20分钟上传一次温度，不像绿米温度传感器（每变化0.5°C，则上传温度）；其次，网关收到信号后，居然不是本地判断+执行的！也就是说如果你正好断网断流一会，控制逻辑则会等到网络恢复 还是 下次数据上传给服务器 才会执行。在后来的调查中，发现很多养鱼或者其他圈的也被这套系统坑过。
因为我功课没做好，直接导致3星期左右大的小太阳在50°C的环境中 呆了可能有20分钟。当时整个鸟眼镜就闭上了，尽管送医救了回来，几天后的凌晨，小鸟突然暴毙了。
因为这个失误老婆痛哭的场景我永远记在心里，告诫自己要细心严谨。

我也能理解，有时候我跟别人说我这套逻辑中的冗余逻辑，总会被认为是“over-engineered”，或是太费精力费钱或者没必要。
说实话，我这套逻辑还是有漏洞的，但确实我觉得在合适的价格里做到我自认为reliable了，以及有足够冗余了。

之前小佩闹出的饮水机电死猫，猫窝翻了，导致猫窒息；以及其他品牌电动猫砂盆夹死猫现象。个人想法：小佩在1代猫砂盆里加了很多传感器，就是为了避免事故发生。但是小佩在“2代”猫砂盆里做了一些优化，但也做了一些减法。这些事故很难完全避免，我感觉小佩也想在安全与成本中找到一个平衡点。

Anyway.



ESP32:

<img src="https://user-images.githubusercontent.com/1382734/217273326-d0e99e39-cd2b-41f0-9a1f-8914bd947908.png" width="400" height="300">

ESP的核心功能有：
1. 温度测量（共9个温度计）
  --在温度过低，或者过高时候，强制启动保暖/通风程序
2. 通风扇开关与控制
  --PWM控制风扇速度，同时监测RPM数据，确保暖风模式的电器安全
3. PID控制器、PTC电源、以及485通讯
  --暖风 与 加热平台的开关
  --485通讯，确保温度在预期范围内，若有不正常，则断电。确保PTC加热设备的电器安全
  --自检程序，确保PTC加热设备的电器安全
4. 体重测量
  --集成ADS1232芯片，获取体重秤数据


Home Assitant:


<img src="https://user-images.githubusercontent.com/1382734/217272975-b6ff87fa-e16d-4482-95ba-0aed1bb4f53a.png" width="900" height="600">

HA的核心功能为：
1. APP的 UI以及前端控制
2. 集成米家设备(如电动窗帘，增加温度测量、控制的冗余。
3. 设计时担心若ESP32卡死，并且不能自我恢复, 可以进行power cycle。（目前看来概率挺小，并且ESP32本身集成WacthDog）




微信推送+控制：

<img src="https://user-images.githubusercontent.com/1382734/217273670-72937f08-5314-442f-9899-8162d8fda784.png" width="800" height="500">

这部分做在了NodeRed里，因为NodeRed社区有现成的企业微信推送和收发模块。
其实这个也可以做在HA里，自己调用收发的API就行。目前想法是这个HA instance主要给鸟笼使用，家用的智能控制放在了NodeRed里。



